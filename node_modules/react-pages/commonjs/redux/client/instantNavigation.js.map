{"version":3,"file":"instantNavigation.js","names":["instantNavigationChain","instantNavigationChainIndex","addInstantBack","nextLocation","previousLocation","nextLocationRouteComponents","previousLocationRouteComponents","chain","length","previousLocationIndex","indexOfByKey","getLocationKey","slice","key","routes","sameRoutesIndex","findSameRoutesLocationIndex","push","isInstantTransition","fromLocation","toLocation","resetInstantNavigationChain","updateInstantNavigationChainIndex","location","i","console","error","j","wasInstantNavigation","window","_ReactPages_Page_NavigationWasInstant","isInstantBackAbleNavigation","_ReactPages_Page_NavigationIsInstantBack","setInstantNavigationFlag","value","markImmediateNavigationAsInstantBack","instantBack","_ReactPages_Page_IsInstantBackNavigation","setTimeout","canGoBackInstantly","canGoForwardInstantly"],"sources":["../../../lib/redux/client/instantNavigation.js"],"sourcesContent":["let instantNavigationChain = []\r\nlet instantNavigationChainIndex = -1\r\n\r\n/**\r\n * Is called when a `<Link/>` with `instantBack` property set is clicked.\r\n *\r\n * Stores \"current\" (soon to be \"previous\") location in \"instant back chain\",\r\n * so that if \"Back\" is clicked later then the transition to this\r\n * \"current\" (soon to be \"previous\") location is marked as \"should be instant\".\r\n *\r\n * \"Instant back chain\" consists of locations stored as a consequitive chain\r\n * and theoretically there can be more than one consequtive \"instant back\"-able\r\n * navigation in it (e.g. page1 -> page2 -> page3 -> \"Back\" -> page2 -> \"Back\" -> page3)\r\n * though I wouldn't advice doing that and would keep it minimal (a chain of two locations).\r\n *\r\n * Once a regular navigation is performed (i.e. not \"instant one\")\r\n * then the whole \"instant back chain\" is discarded.\r\n * E.g. a user clicks on `<Link instantBack/>` and is taken to a page\r\n * where he clicks on another `<Link/>` now without `instantBack` -\r\n * in this case all \"instant back\" history is discarded\r\n * and if the user clicks \"Back\" two times the second time won't be \"instant\".\r\n */\r\nexport function addInstantBack(\r\n\tnextLocation,\r\n\tpreviousLocation,\r\n\tnextLocationRouteComponents,\r\n\tpreviousLocationRouteComponents\r\n)\r\n{\r\n\tlet chain = instantNavigationChain\r\n\r\n\t// If there is already an \"instant\" transition in the chain\r\n\t// then insert this transition into the chain\r\n\t// only if it's \"page1 -> page2\" and \"page2 -> page3\"\r\n\t// so that the chain becomes \"page1 -> page2 -> page3\".\r\n\t// Otherwise, the already existing \"instant back\" chain is reset.\r\n\tif (chain.length > 0)\r\n\t{\r\n\t\tconst previousLocationIndex = indexOfByKey(chain, getLocationKey(previousLocation))\r\n\r\n\t\tif (previousLocationIndex >= 0)\r\n\t\t{\r\n\t\t\t// If transitioning from \"page2\" to \"page3\"\r\n\t\t\t// and the existing chain is \"page1 -> page2 -> page4\"\r\n\t\t\t// then trim the chain up to the \"current\" page\r\n\t\t\t// so that it becomes \"page1 -> page2\" (eligible for merging).\r\n\t\t\tchain = chain.slice(0, previousLocationIndex + 1)\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t// console.error('[react-pages] Error: previous location not found in an already existing instant back navigation chain', getLocationKey(previousLocation), chain)\r\n\t\t\t// Anomaly detected.\r\n\t\t\t// Reset the chain.\r\n\t\t\t// return resetInstantNavigationChain()\r\n\r\n\t\t\t// Basic recovery for cases where `history.replaceState()`\r\n\t\t\t// or `replaceHistory()` were called.\r\n\t\t\t// (e.g. Algolia \"Instant Search\" widget filters reconfigured)\r\n\t\t\tchain = []\r\n\t\t}\r\n\t}\r\n\r\n\tif (chain.length === 0)\r\n\t{\r\n\t\t// Add the \"current\" page to the chain.\r\n\t\tchain =\r\n\t\t[{\r\n\t\t\tkey : getLocationKey(previousLocation),\r\n\t\t\troutes : previousLocationRouteComponents\r\n\t\t}]\r\n\t}\r\n\r\n\t// Discard \"instant back\" chain part having same routes.\r\n\tconst sameRoutesIndex = findSameRoutesLocationIndex(chain, nextLocationRouteComponents)\r\n\tif (sameRoutesIndex >= 0) {\r\n\t\tchain = chain.slice(sameRoutesIndex + 1)\r\n\t}\r\n\r\n\t// Add the \"next\" page to the chain.\r\n\tchain.push({\r\n\t\tkey : getLocationKey(nextLocation),\r\n\t\troutes : nextLocationRouteComponents\r\n\t})\r\n\r\n\t// Save the chain.\r\n\tinstantNavigationChain = chain\r\n\tinstantNavigationChainIndex = chain.length - 1\r\n}\r\n\r\n/**\r\n * Checks if a \"Back\"/\"Forward\" transition should be \"instant\".\r\n * For \"Back\" transition it would mean that\r\n * the `<Link/>` has `instantBack` property set.\r\n * For \"Forward\" transition it would mean that\r\n * it's a reverse of an instant \"Back\" transition.\r\n * The order and position inside `chain` don't matter.\r\n */\r\nexport function isInstantTransition(fromLocation, toLocation)\r\n{\r\n\treturn indexOfByKey(instantNavigationChain, getLocationKey(fromLocation)) >= 0 &&\r\n\t\tindexOfByKey(instantNavigationChain, getLocationKey(toLocation)) >= 0\r\n}\r\n\r\n/**\r\n * Clears any \"instant back\" history.\r\n */\r\nexport function resetInstantNavigationChain() {\r\n\tinstantNavigationChain = []\r\n\tinstantNavigationChainIndex = -1\r\n}\r\n\r\n/**\r\n * Updates instant navigation chain's current route index.\r\n */\r\nexport function updateInstantNavigationChainIndex(location) {\r\n\tlet i = 0\r\n\twhile (i < instantNavigationChain.length) {\r\n\t\tif (instantNavigationChain[i].key === getLocationKey(location)) {\r\n\t\t\tinstantNavigationChainIndex = i\r\n\t\t\treturn\r\n\t\t}\r\n\t\ti++\r\n\t}\r\n\t// Shouldn't happen.\r\n\tconsole.error('[react-pages] Location not found in instant navigation chain', location)\r\n\tinstantNavigationChainIndex = -1\r\n}\r\n\r\n/**\r\n * Each history `location` has a randomly generated `key`.\r\n */\r\nconst getLocationKey = location => location.key\r\n\r\nfunction indexOfByKey(chain, key) {\r\n\tlet i = 0\r\n\twhile (i < chain.length) {\r\n\t\tif (chain[i].key === key) {\r\n\t\t\treturn i\r\n\t\t}\r\n\t\ti++\r\n\t}\r\n\treturn -1\r\n}\r\n\r\nfunction findSameRoutesLocationIndex(chain, routes) {\r\n\tlet i = 0\r\n\twhile (i < chain.length) {\r\n\t\tif (chain[i].routes.length === routes.length) {\r\n\t\t\tlet j = 0\r\n\t\t\twhile (j < routes.length) {\r\n\t\t\t\tif (chain[i].routes[j] !== routes[j]) {\r\n\t\t\t\t\tbreak\r\n\t\t\t\t}\r\n\t\t\t\tj++\r\n\t\t\t}\r\n\t\t\tif (j === routes.length) {\r\n\t\t\t\treturn i\r\n\t\t\t}\r\n\t\t}\r\n\t\ti++\r\n\t}\r\n\treturn -1\r\n}\r\n\r\n// Can be used to find out if the current page\r\n// transition was an \"instant\" one.\r\n// E.g. an Algolia \"Instant Search\" component\r\n// could reset the stored cached `resultsState`\r\n// if the transition was not an \"instant\" one.\r\nexport function wasInstantNavigation() {\r\n\treturn typeof window !== 'undefined' && window._ReactPages_Page_NavigationWasInstant === true\r\n}\r\n\r\nexport function isInstantBackAbleNavigation() {\r\n\treturn typeof window !== 'undefined' && window._ReactPages_Page_NavigationIsInstantBack\r\n}\r\n\r\nexport function setInstantNavigationFlag(value) {\r\n\tif (typeof window !== 'undefined') {\r\n\t\twindow._ReactPages_Page_NavigationWasInstant = value\r\n\t}\r\n}\r\n\r\n/**\r\n * This function is also called with `false`\r\n * in order to set the flag to `false`.\r\n * Theoretically that might make sense in case of\r\n * two immediately consequtive `goto()` calls or something.\r\n * Though it's not a sane use case and may be considered invalid.\r\n * @param  {boolean} [instantBack]\r\n * @return\r\n */\r\nexport function markImmediateNavigationAsInstantBack(instantBack) {\r\n\t// Is being read in `./redux/middleware/router.js`\r\n\twindow._ReactPages_Page_IsInstantBackNavigation = instantBack\r\n\tif (instantBack) {\r\n\t\t// Resetting the flag immediately after it's processed in router's POP event listener.\r\n\t\t// Could reset it there too.\r\n\t\t// Not resetting on some \"on navigation finished\" event because\r\n\t\t// `load` could throw and the navigation wouldn't conclude in that case.\r\n\t\tsetTimeout(() => window._ReactPages_Page_IsInstantBackNavigation = false, 0)\r\n\t}\r\n}\r\n\r\nexport function canGoBackInstantly() {\r\n\treturn instantNavigationChainIndex > 0\r\n}\r\n\r\nexport function canGoForwardInstantly() {\r\n\treturn instantNavigationChainIndex < instantNavigationChain.length - 1\r\n}"],"mappings":"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"}