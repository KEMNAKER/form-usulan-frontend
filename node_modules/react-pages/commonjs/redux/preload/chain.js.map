{"version":3,"file":"chain.js","names":["generatePreloadChain","preloaders","server","isInitialClientSidePreload","getState","dispatch","location","params","history","getCookie","preloading","setUpPreloaders","filter_preloaders","chain","chain_preloaders","length","promisify","preload_arguments","component_preloaders","preloader","setUpPreloader","preload","isServerSidePreloaded","options","client","slice","forEach","_","i","filter","parallel","concat","is_preloader_blocking","get_preloader","Array","isArray","sibling_preloader","blocking","blockingSibling","Promise","all","map","link","then","results","reduce","combined","result","promise","cancelled","nextResult","resolve","array","part"],"sources":["../../../lib/redux/preload/chain.js"],"sourcesContent":["import { isServerSidePreloaded } from '../../client/flags.js'\r\n\r\n// Returns function returning a Promise\r\n// which resolves when all the required page `load`s are resolved.\r\n//\r\n// If no preloading is needed, then returns nothing.\r\n//\r\nexport default function generatePreloadChain\r\n(\r\n\tpreloaders,\r\n\tserver,\r\n\tisInitialClientSidePreload,\r\n\tgetState,\r\n\tdispatch,\r\n\tlocation,\r\n\tparams,\r\n\thistory,\r\n\tgetCookie,\r\n\tpreloading\r\n)\r\n{\r\n\t// Set `.preload({ ... })` function arguments,\r\n\t// and also set default `load` options.\r\n\tsetUpPreloaders(\r\n\t\tpreloaders,\r\n\t\t{\r\n\t\t\tdispatch,\r\n\t\t\tgetState,\r\n\t\t\tlocation,\r\n\t\t\tparams,\r\n\t\t\thistory,\r\n\t\t\tserver,\r\n\t\t\t// `getCookie` `load` parameter has been requested:\r\n\t\t\t// https://github.com/catamphetamine/react-website/issues/71\r\n\t\t\tgetCookie\r\n\t\t},\r\n\t\tserver\r\n\t)\r\n\r\n\t// Only select those `load`s which\r\n\t// should be run in current circumstances.\r\n\tpreloaders = filter_preloaders(preloaders, server, isInitialClientSidePreload)\r\n\r\n\t// Construct a sequential chain out of preloaders.\r\n\t// Because each of them could be either parallel or sequential.\r\n\tconst chain = chain_preloaders(preloaders)\r\n\r\n\t// If there are no `load`s for this route, then exit.\r\n\tif (chain.length === 0) {\r\n\t\treturn\r\n\t}\r\n\r\n\t// Return a function which generates preloading `Promise` chain.\r\n\treturn () => promisify(chain, preloading)\r\n}\r\n\r\n// Applies default `load` options\r\n// and sets `load` function arguments.\r\nfunction setUpPreloaders(preloaders, preload_arguments, server)\r\n{\r\n\tfor (const component_preloaders of preloaders) {\r\n\t\tfor (const preloader of component_preloaders) {\r\n\t\t\tsetUpPreloader(preloader, preload_arguments, server)\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// Applies default `load` options\r\n// and sets `load` function arguments.\r\nfunction setUpPreloader(preloader, preload_arguments, server)\r\n{\r\n\tconst preload = preloader.preload\r\n\tpreloader.preload = () => preload(preload_arguments)\r\n\r\n\t// If Server-Side Rendering is not being used at all\r\n\t// then all `load`s must be marked as client-side ones.\r\n\tif (!server && !isServerSidePreloaded()) {\r\n\t\tpreloader.options.client = true\r\n\t}\r\n}\r\n\r\n// Selects only those `load`s which\r\n// should be run in current circumstances.\r\nexport function filter_preloaders(preloaders, server, isInitialClientSidePreload)\r\n{\r\n\t// `preloaders` array will be mutated\r\n\tpreloaders = preloaders.slice()\r\n\r\n\tpreloaders.forEach((_, i) =>\r\n\t{\r\n\t\tpreloaders[i] = preloaders[i].filter((preloader) =>\r\n\t\t{\r\n\t\t\t// Don't execute client-side-only `load`s on server side\r\n\t\t\tif (preloader.options.client && server) {\r\n\t\t\t\treturn false\r\n\t\t\t}\r\n\t\t\t// Don't execute server-side-only `load`s on client side\r\n\t\t\tif (preloader.options.server && !server) {\r\n\t\t\t\treturn false\r\n\t\t\t}\r\n\t\t\t// If it's initial client side preload (after the page has been loaded),\r\n\t\t\t// then only execute those `load`s marked as \"client-side-only\".\r\n\t\t\tif (isInitialClientSidePreload && !preloader.options.client) {\r\n\t\t\t\treturn false\r\n\t\t\t}\r\n\t\t\treturn true\r\n\t\t})\r\n\t})\r\n\r\n\treturn preloaders.filter(component_preloaders => component_preloaders.length > 0)\r\n}\r\n\r\n// Constructs `preload` chain.\r\n//\r\n// @param `preloaders` is an array of `component_preloaders`.\r\n// `component_preloaders` is an array of all\r\n// `load`s for a particular React component.\r\n// Therefore `preloaders` is an array of arrays.\r\nexport function chain_preloaders(preloaders, chain = [], parallel = [])\r\n{\r\n\t// If all `preload`s have been visited\r\n\tif (preloaders.length === 0)\r\n\t{\r\n\t\tif (parallel.length === 0) {\r\n\t\t\treturn chain\r\n\t\t}\r\n\t\t// Finalize pending parallel `preload`s\r\n\t\tif (parallel.length === 1) {\r\n\t\t\treturn chain.concat(parallel)\r\n\t\t}\r\n\t\treturn chain.concat({ parallel })\r\n\t}\r\n\r\n\t// `component_preloaders` is an array of all\r\n\t// `load`s for a particular React component.\r\n\tconst preloader = preloaders[0]\r\n\tpreloaders = preloaders.slice(1)\r\n\r\n\tif (!is_preloader_blocking(preloader))\r\n\t{\r\n\t\treturn chain_preloaders(\r\n\t\t\tpreloaders,\r\n\t\t\tchain,\r\n\t\t\tconcat(parallel, get_preloader(preloader))\r\n\t\t)\r\n\t}\r\n\r\n\tif (parallel.length === 0)\r\n\t{\r\n\t\treturn chain_preloaders(\r\n\t\t\tpreloaders,\r\n\t\t\tconcat(chain, get_preloader(preloader)),\r\n\t\t\t[]\r\n\t\t)\r\n\t}\r\n\r\n\treturn chain_preloaders(\r\n\t\tpreloaders,\r\n\t\tchain.concat({ parallel: concat(parallel, get_preloader(preloader)) }),\r\n\t\t[]\r\n\t)\r\n}\r\n\r\nfunction get_preloader(preloader)\r\n{\r\n\t// A list of same component's `load`s\r\n\tif (Array.isArray(preloader)) {\r\n\t\treturn chain_preloaders(preloader)\r\n\t}\r\n\r\n\t// Same component adjacent `load`\r\n\treturn preloader.preload\r\n}\r\n\r\nfunction is_preloader_blocking(preloader)\r\n{\r\n\t// A list of same component's `load`s\r\n\tif (Array.isArray(preloader))\r\n\t{\r\n\t\t// Determine the proper `blocking` option\r\n\t\t// for this component's `load`s.\r\n\t\tfor (const sibling_preloader of preloader)\r\n\t\t{\r\n\t\t\t// If any of component's `load`s are `blocking: true`\r\n\t\t\t// then all of them are `blocking: true`.\r\n\t\t\tif (sibling_preloader.options.blocking)\r\n\t\t\t{\r\n\t\t\t\treturn true\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn false\r\n\t}\r\n\r\n\t// Same component adjacent `load`\r\n\treturn preloader.options.blockingSibling\r\n}\r\n\r\n// Returns a `Promise` chain.\r\nexport function promisify(chain, preloading)\r\n{\r\n\tif (typeof chain === 'function') {\r\n\t\treturn chain()\r\n\t}\r\n\r\n\tif (typeof chain === 'object' && chain.parallel)\r\n\t{\r\n\t\treturn Promise.all(chain.parallel.map(link => promisify(link, preloading)))\r\n\t\t\t.then((results) => {\r\n\t\t\t\treturn results.reduce((combined, result) => ({\r\n\t\t\t\t\t...combined,\r\n\t\t\t\t\t...result\r\n\t\t\t\t}), {})\r\n\t\t\t})\r\n\t}\r\n\r\n\treturn chain.reduce((promise, link) =>\r\n\t{\r\n\t\treturn promise.then((result) =>\r\n\t\t{\r\n\t\t\tif (preloading.cancelled) {\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\t\t\treturn promisify(link, preloading).then((nextResult) => ({\r\n\t\t\t\t...result,\r\n\t\t\t\t...nextResult\r\n\t\t\t}))\r\n\t\t})\r\n\t},\r\n\tPromise.resolve())\r\n}\r\n\r\nfunction concat(array, part)\r\n{\r\n\tif (Array.isArray(part) && part.length > 1) {\r\n\t\t// Pushes an array\r\n\t\treturn array.concat([part])\r\n\t}\r\n\t// Pushes a single element\r\n\treturn array.concat(part)\r\n}"],"mappings":"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"}