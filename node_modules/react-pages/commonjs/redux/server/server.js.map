{"version":3,"file":"server.js","names":["initialize","settings","proxy","cookies","headers","locales","url","getInitialState","httpClient","createHttpClient","store","server","fetch","undefined","initialState","createStore","createHistoryProtocol","getCookie","name","generateJavascript","cookiesSetOnServer","code","parseDates","DEFINE_JSON_DATE_PARSER","JSON","stringify","safeJsonStringify","getState","ISO_date_regexp","indexOf","Error"],"sources":["../../../lib/redux/server/server.js"],"sourcesContent":["// Currently, `fetch` is not used.\r\n// But it could be used in some future instead of `superagent`.\r\n//\r\n// While it's not used, I've commented it out\r\n// because it broke CommonJS import support.\r\n//\r\n// import fetch from 'node-fetch'\r\n\r\nimport { ISO_date_regexp } from '../../parseDates.js'\r\nimport { safeJsonStringify } from '../../server/html.js'\r\nimport createStore from '../store.js'\r\nimport createHttpClient from '../HttpClient.js'\r\nimport createHistoryProtocol from '../../router/server/createHistoryProtocol.js'\r\n\r\nexport async function initialize(settings, {\r\n\tproxy,\r\n\tcookies,\r\n\theaders,\r\n\tlocales,\r\n\turl,\r\n\tgetInitialState\r\n}) {\r\n\t// Redux store\r\n\tlet store\r\n\r\n\t// Create HTTP client (Redux action creator `http` utility)\r\n\tconst httpClient = createHttpClient(settings, () => store, {\r\n\t\tproxy,\r\n\t\tcookies,\r\n\t\tserver: true,\r\n\t\tfetch: undefined\r\n\t})\r\n\r\n\t// Initial Redux state.\r\n\t// `User-Agent` and `Accept-Language` headers were requested:\r\n\t// https://github.com/catamphetamine/react-website/issues/72\r\n\tconst initialState = getInitialState ? getInitialState({\r\n\t\tcookies,\r\n\t\theaders,\r\n\t\tlocales\r\n\t}) : {}\r\n\r\n\t// Create Redux store.\r\n\tstore = createStore(settings, initialState, () => createHistoryProtocol(url), httpClient, {\r\n\t\tgetCookie: name => cookies[name],\r\n\t\tserver: true\r\n\t})\r\n\r\n\treturn {\r\n\t\tstore,\r\n\t\tgenerateJavascript: () => generateJavascript(store, settings),\r\n\t\tcookies: httpClient.cookiesSetOnServer\r\n\t}\r\n}\r\n\r\nfunction generateJavascript(store, settings) {\r\n\tlet code = ''\r\n\r\n\t// JSON Date deserializer\r\n\tif (settings.parseDates) {\r\n\t\tcode += `<script>${DEFINE_JSON_DATE_PARSER}</script>`\r\n\t}\r\n\r\n\t// Store data will be reloaded into the store on the client-side.\r\n\t// All forward slashes are escaped to prevent XSS attacks.\r\n\t// Another solution would be replacing with `\\uxxxx` sequences.\r\n\t// https://medium.com/node-security/the-most-common-xss-vulnerability-in-react-js-applications-2bdffbcc1fa0\r\n\tcode += `<script>`\r\n\tcode += `window._redux_state = JSON.parse(${ JSON.stringify(safeJsonStringify(store.getState())) }${ settings.parseDates ? ', JSON.dateParser' : '' })`\r\n\tcode += `</script>`\r\n\r\n\treturn code\r\n}\r\n\r\n// JSON date deserializer.\r\n// Use as the second, 'reviver' argument to `JSON.parse(json, JSON.dateParser)`.\r\n// http://stackoverflow.com/questions/14488745/javascript-json-date-deserialization/23691273#23691273\r\n// `JSON.parse(json, JSON.dateParser)` is about 2.5 times slower than `JSON.parse(json)` in Chrome.\r\nconst DEFINE_JSON_DATE_PARSER = `\r\nif (!JSON.dateParser) {\r\n\tJSON.dateParser = function(key, value) {\r\n\t\tif (typeof value === 'string' && /^${ISO_date_regexp}$/.test(value)) {\r\n\t\t\treturn new Date(value)\r\n\t\t}\r\n\t\treturn value\r\n\t}\r\n}`\r\n\r\n// Since version 6.x, `terser` no longer provides a synchronous `minify()` function.\r\n// import Terser from 'terser'\r\n// DEFINE_JSON_DATE_PARSER = Terser.minify(DEFINE_JSON_DATE_PARSER).code\r\n\r\n// Just to be extra safe from XSS attacks\r\nif (DEFINE_JSON_DATE_PARSER.indexOf('<') !== -1) {\r\n\tthrow new Error('JSON Date parser XSS vulnerability detected')\r\n}"],"mappings":";;;;;;AAQA;AACA;AACA;AACA;AACA;AAAgF;AAAA;AAAA,+CAXhF;AAAA;AAAA;AAAA,SAasBA,UAAU;EAAA;AAAA;AAAA;EAAA,yEAAzB,iBAA0BC,QAAQ;IAAA;IAAA;MAAA;QAAA;UACxCC,KAAK,QAALA,KAAK,EACLC,OAAO,QAAPA,OAAO,EACPC,OAAO,QAAPA,OAAO,EACPC,OAAO,QAAPA,OAAO,EACPC,GAAG,QAAHA,GAAG,EACHC,eAAe,QAAfA,eAAe;UAKf;UACMC,UAAU,GAAG,IAAAC,sBAAgB,EAACR,QAAQ,EAAE;YAAA,OAAMS,KAAK;UAAA,GAAE;YAC1DR,KAAK,EAALA,KAAK;YACLC,OAAO,EAAPA,OAAO;YACPQ,MAAM,EAAE,IAAI;YACZC,KAAK,EAAEC;UACR,CAAC,CAAC,EAEF;UACA;UACA;UACMC,YAAY,GAAGP,eAAe,GAAGA,eAAe,CAAC;YACtDJ,OAAO,EAAPA,OAAO;YACPC,OAAO,EAAPA,OAAO;YACPC,OAAO,EAAPA;UACD,CAAC,CAAC,GAAG,CAAC,CAAC,EAEP;UACAK,KAAK,GAAG,IAAAK,iBAAW,EAACd,QAAQ,EAAEa,YAAY,EAAE;YAAA,OAAM,IAAAE,iCAAqB,EAACV,GAAG,CAAC;UAAA,GAAEE,UAAU,EAAE;YACzFS,SAAS,EAAE,mBAAAC,IAAI;cAAA,OAAIf,OAAO,CAACe,IAAI,CAAC;YAAA;YAChCP,MAAM,EAAE;UACT,CAAC,CAAC;UAAA,iCAEK;YACND,KAAK,EAALA,KAAK;YACLS,kBAAkB,EAAE;cAAA,OAAMA,mBAAkB,CAACT,KAAK,EAAET,QAAQ,CAAC;YAAA;YAC7DE,OAAO,EAAEK,UAAU,CAACY;UACrB,CAAC;QAAA;QAAA;UAAA;MAAA;IAAA;EAAA,CACD;EAAA;AAAA;AAED,SAASD,mBAAkB,CAACT,KAAK,EAAET,QAAQ,EAAE;EAC5C,IAAIoB,IAAI,GAAG,EAAE;;EAEb;EACA,IAAIpB,QAAQ,CAACqB,UAAU,EAAE;IACxBD,IAAI,sBAAeE,uBAAuB,cAAW;EACtD;;EAEA;EACA;EACA;EACA;EACAF,IAAI,cAAc;EAClBA,IAAI,+CAAyCG,IAAI,CAACC,SAAS,CAAC,IAAAC,uBAAiB,EAAChB,KAAK,CAACiB,QAAQ,EAAE,CAAC,CAAC,SAAK1B,QAAQ,CAACqB,UAAU,GAAG,mBAAmB,GAAG,EAAE,MAAI;EACvJD,IAAI,eAAe;EAEnB,OAAOA,IAAI;AACZ;;AAEA;AACA;AACA;AACA;AACA,IAAME,uBAAuB,2HAGUK,2BAAe,qFAKpD;;AAEF;AACA;AACA;;AAEA;AACA,IAAIL,uBAAuB,CAACM,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,EAAE;EAChD,MAAM,IAAIC,KAAK,CAAC,6CAA6C,CAAC;AAC/D"}